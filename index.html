<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WordMaster Pro</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #bb86fc; --text: #e0e0e0; --sub: #a0a0a0; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: env(safe-area-inset-bottom); }
        
        /* 頂部導覽 */
        .app-bar { position: sticky; top: 0; background: rgba(18,18,18,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 15px; z-index: 1000; border-bottom: 1px solid #333; }
        .menu-btn { background: var(--primary); color: #000; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .toggle-btn { background: #2c2c2c; color: var(--primary); border: 1px solid #444; padding: 6px 10px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .search-input { background: #2c2c2c; border: 1px solid #444; border-radius: 10px; padding: 10px; width: 100%; color: white; box-sizing: border-box; outline: none; flex: 1; }
        .stats { color: var(--sub); font-size: 14px; text-align: center; margin-bottom: 10px; }

        /* 全螢幕三層選單 */
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; padding: 40px 20px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; max-width: 400px; }
        .grid-item { background: #333; color: var(--primary); height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; font-weight: bold; cursor: pointer; text-decoration: none; font-size: 16px; }
        .grid-item-count { font-size: 11px; color: var(--sub); margin-top: 2px; }
        .active-mode { border: 2px solid var(--primary); background: #444; }

        /* 單字卡片 */
        .content { padding: 15px; }
        .word-card { background: var(--card); border-radius: 12px; padding: 18px 18px 18px 55px; margin-bottom: 12px; position: relative; border-left: 4px solid #333; }
        .word-card.mastered { border-left-color: #03dac6; }
        .word-number { position: absolute; left: 15px; top: 18px; color: var(--sub); font-size: 16px; font-weight: bold; }
        .word-number.hidden { display: none; }
        .word-title { font-size: 24px; font-weight: bold; color: var(--primary); cursor: pointer; display: inline-block; }
        .word-title.masked { filter: blur(12px); background: #333; color: transparent; border-radius: 4px; user-select: none; }
        .star { position: absolute; top: 18px; right: 18px; color: #555; font-size: 20px; cursor: default; }
        .star.active { color: #f1c40f; }
        .divider { font-size: 28px; font-weight: 900; color: #444; margin: 30px 0 10px; border-bottom: 2px solid #333; }
    </style>
</head>
<body>

<div class="menu-overlay" id="menuOverlay">
    <div style="color:white; margin-bottom:20px; font-weight:bold;" id="navStep">第一層：學習狀態</div>
    <div id="modeSection" class="grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom:30px; width:100%;">
        <div class="grid-item active-mode" id="m-all" onclick="setMode('all')">
            <div>全部</div>
            <div class="grid-item-count" id="count-all">0</div>
        </div>
        <div class="grid-item" id="m-1" onclick="setMode('1')">
            <div>已熟</div>
            <div class="grid-item-count" id="count-1">0</div>
        </div>
        <div class="grid-item" id="m-0" onclick="setMode('0')">
            <div>未熟</div>
            <div class="grid-item-count" id="count-0">0</div>
        </div>
    </div>
    <div id="menuGrid" class="grid"></div>
    <button onclick="toggleMenu(false)" style="margin-top:30px; background:none; border:1px solid white; color:white; padding:10px 30px; border-radius:20px;">關閉</button>
</div>

<div class="app-bar">
    <button class="menu-btn" style="width: 100%;" onclick="openL1()">目錄</button>
    <div class="stats" id="statsDisplay">載入中...</div>
    <div class="btn-row">
        <button class="toggle-btn" onclick="toggleAllWords()" id="toggleBtn">遮住</button>
        <button class="toggle-btn" onclick="toggleNumbers()" id="numberBtn">編號</button>
        <input type="text" id="searchInput" class="search-input" placeholder="搜尋單字、中文...">
    </div>
</div>

<main class="content" id="listBody"></main>

<script>
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvabePqyogTjHeINnBYyZWK6uQpJikumzN__QbAg7Z38CurIlE8LYapPUuayBwgYH_hQuMcQ0ir0Ym/pub?output=csv';
    let wordDB = [];
    let currentMode = 'all';
    let currentFilter = null;
    let isMasked = false;
    let showNumbers = true;

    async function init() {
        try {
            const res = await fetch(SHEET_CSV);
            const csv = await res.text();
            const rows = csv.split(/\r?\n/).slice(1);
            wordDB = rows.map(r => {
                const p = r.split(',');
                return { 
                    w: (p[0] || '').replace(/"/g,'').trim(),
                    p: (p[1] || '').replace(/"/g,'').trim(),
                    d: (p[2] || '').replace(/"/g,'').trim(),
                    u: (p[3] || '').replace(/"/g,'').trim(),
                    s: (p[4] || '').replace(/"/g,'').trim()
                };
            }).filter(i => i.w && i.w.length > 0);
            
            updateStats();
            render();
        } catch (e) { 
            console.error('載入錯誤:', e);
            alert('同步失敗：' + e.message); 
        }
    }

    function updateStats() {
        const total = wordDB.length;
        const mastered = wordDB.filter(i => i.s === '1').length;
        const learning = wordDB.filter(i => i.s === '0' || i.s === '').length;
        
        document.getElementById('statsDisplay').innerHTML = `總計：${total} 個單字 | 已熟：${mastered} | 未熟：${learning}`;
        document.getElementById('count-all').textContent = total;
        document.getElementById('count-1').textContent = mastered;
        document.getElementById('count-0').textContent = learning;
    }

    function render(filterData = null) {
        let data = filterData || wordDB;
        
        // 套用目前的篩選條件
        if (currentFilter) {
            data = data.filter(i => {
                if (currentFilter.type === 'letter') {
                    return i.w[0].toUpperCase() === currentFilter.value;
                } else if (currentFilter.type === 'prefix') {
                    return i.w.substring(0, 2).toUpperCase() === currentFilter.value;
                }
                return true;
            });
        }
        
        const sortedData = [...data].sort((a, b) => a.w.localeCompare(b.w));
        let html = '';
        let addedDividers = new Set();
        let wordCount = 0; // 單字計數器
        
        sortedData.forEach(item => {
            const isMastered = item.s === '1';
            const isLearning = item.s === '0' || item.s === '';
            
            if (currentMode === '1' && !isMastered) return;
            if (currentMode === '0' && !isLearning) return;
            
            wordCount++; // 每個顯示的單字都增加編號
            
            const l2 = item.w.substring(0, 2).toUpperCase();
            if (!addedDividers.has(l2)) {
                html += `<div class="divider" id="idx-${l2}">${l2}</div>`;
                addedDividers.add(l2);
            }
            html += `
                <div class="word-card ${isMastered?'mastered':''}">
                    <div class="word-number ${showNumbers?'':'hidden'}">${wordCount}</div>
                    <span class="star ${isMastered?'active':''}" onclick="event.stopPropagation()">★</span>
                    <div class="word-title ${isMasked?'masked':''}" onclick="this.classList.toggle('masked')">${item.w}</div>
                    <div style="margin-top:8px;">${item.d}</div>
                    <div style="color:var(--sub); font-size:13px; margin-top:5px;">${item.p || ''}</div>
                </div>`;
        });
        document.getElementById('listBody').innerHTML = html || '<div style="text-align:center; color:var(--sub); padding:40px;">無符合的單字</div>';
    }

    function setMode(m) {
        currentMode = m;
        currentFilter = null;
        document.querySelectorAll('#modeSection .grid-item').forEach(el => el.classList.remove('active-mode'));
        document.getElementById(`m-${m}`).classList.add('active-mode');
        updateL2Menu();
    }

    function updateL2Menu() {
        document.getElementById('navStep').innerText = "第二層：選擇 A-Z";
        const letters = new Map();
        
        wordDB.forEach(i => {
            if (!i.w) return;
            
            const isMastered = i.s === '1';
            const isLearning = i.s === '0' || i.s === '';
            
            if (currentMode === 'all' || 
                (currentMode === '1' && isMastered) || 
                (currentMode === '0' && isLearning)) {
                const letter = i.w[0].toUpperCase();
                letters.set(letter, (letters.get(letter) || 0) + 1);
            }
        });
        
        let html = `<div class="grid-item" style="background:#444" onclick="openL1()">← 返回</div>`;
        html += `<div class="grid-item" style="background:#4a4a4a; grid-column: span 3;" onclick="showAllInMode()">顯示全部</div>`;
        html += Array.from(letters.keys()).sort().map(l => 
            `<div class="grid-item" onclick="selectLetter('${l}')">
                <div>${l}</div>
                <div class="grid-item-count">${letters.get(l)}</div>
            </div>`
        ).join('');
        document.getElementById('menuGrid').innerHTML = html;
    }

    function showAllInMode() {
        currentFilter = null;
        toggleMenu(false);
        render();
        setTimeout(() => window.scrollTo({ top: 0, behavior: 'smooth' }), 100);
    }

    function openL1() {
        document.getElementById('navStep').innerText = "第一層：學習狀態";
        document.getElementById('menuGrid').innerHTML = '';
        toggleMenu(true);
    }

    function selectLetter(letter) {
        document.getElementById('navStep').innerText = `第三層：${letter} 開頭組合`;
        const subs = new Map();
        
        wordDB.forEach(i => {
            if (!i.w || i.w[0].toUpperCase() !== letter) return;
            
            const isMastered = i.s === '1';
            const isLearning = i.s === '0' || i.s === '';
            
            if (currentMode === 'all' || 
                (currentMode === '1' && isMastered) || 
                (currentMode === '0' && isLearning)) {
                const prefix = i.w.substring(0, 2).toUpperCase();
                subs.set(prefix, (subs.get(prefix) || 0) + 1);
            }
        });
        
        let html = `<div class="grid-item" style="background:#444" onclick="updateL2Menu()">← 返回</div>`;
        html += `<div class="grid-item" style="background:#4a4a4a; grid-column: span 3;" onclick="filterByLetter('${letter}')">顯示全部 ${letter} 開頭</div>`;
        html += Array.from(subs.keys()).sort().map(s => 
            `<div class="grid-item" onclick="filterByPrefix('${s}')">
                <div>${s}</div>
                <div class="grid-item-count">${subs.get(s)}</div>
            </div>`
        ).join('');
        document.getElementById('menuGrid').innerHTML = html;
    }

    function filterByLetter(letter) {
        currentFilter = { type: 'letter', value: letter };
        toggleMenu(false);
        render();
        setTimeout(() => window.scrollTo({ top: 0, behavior: 'smooth' }), 100);
    }

    function filterByPrefix(prefix) {
        currentFilter = { type: 'prefix', value: prefix };
        toggleMenu(false);
        render();
        setTimeout(() => {
            const target = document.getElementById(`idx-${prefix}`);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }, 100);
    }

    function toggleMenu(s) { 
        document.getElementById('menuOverlay').style.display = s ? 'flex' : 'none'; 
    }

    function toggleAllWords() {
        isMasked = !isMasked;
        const allTitles = document.querySelectorAll('.word-title');
        allTitles.forEach(title => {
            if (isMasked) {
                title.classList.add('masked');
            } else {
                title.classList.remove('masked');
            }
        });
        document.getElementById('toggleBtn').textContent = isMasked ? '顯示' : '遮住';
    }

    function toggleNumbers() {
        showNumbers = !showNumbers;
        const allNumbers = document.querySelectorAll('.word-number');
        allNumbers.forEach(num => {
            if (showNumbers) {
                num.classList.remove('hidden');
            } else {
                num.classList.add('hidden');
            }
        });
        document.getElementById('numberBtn').textContent = showNumbers ? '編號' : '編號';
        // 更新按鈕樣式
        document.getElementById('numberBtn').style.opacity = showNumbers ? '1' : '0.5';
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        if (q === '') {
            render();
        } else {
            const f = wordDB.filter(i => i.w.toLowerCase().includes(q) || i.d.includes(q));
            render(f);
        }
    });

    init();
</script>
</body>
</html>
