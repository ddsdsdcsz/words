<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的雲端單字庫</title>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); padding-bottom: 50px; }
        .header { position: sticky; top: 0; background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .search-box { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; }
        button { flex: 1; padding: 10px; border-radius: 5px; border: none; background: var(--primary); color: white; font-weight: bold; }
        .word-card { background: white; margin: 10px; padding: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .word-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .word-text { font-size: 22px; font-weight: bold; color: var(--primary); transition: 0.2s; }
        .word-text.hide { filter: blur(10px); background: #eee; color: transparent; }
        .pos { color: #666; font-style: italic; font-size: 14px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
        .meaning { color: #333; font-size: 17px; margin: 5px 0; }
        .usage { font-size: 14px; color: #777; border-left: 3px solid #ddd; padding-left: 10px; margin-top: 8px; line-height: 1.4; }
        .letter-divider { padding: 8px 15px; font-weight: bold; background: #e5e7eb; color: #4b5563; position: sticky; top: 120px; z-index: 10; }
        .loading { text-align: center; padding: 50px; color: #666; }
    </style>
</head>
<body>

<div class="header">
    <input type="text" id="searchInput" class="search-box" placeholder="搜尋數萬個單字...">
    <div class="controls">
        <button onclick="toggleHide()">遮住/顯示英文</button>
        <button onclick="location.reload()">同步雲端</button>
    </div>
</div>

<div id="loading" class="loading">正在從雲端下載單字庫...</div>
<div id="content"></div>

<script>
    /** * [重要] 請在此處貼上你的 Google Sheets 「發佈到網路」的連結
     * 格式如: https://docs.google.com/spreadsheets/d/e/2PACX-.../pubhtml
     */
    const G_SHEET_PUB_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvabePqyogTjHeINnBYyZWK6uQpJikumzN__QbAg7Z38CurIlE8LYapPUuayBwgYH_hQuMcQ0ir0Ym/pubhtml';

    let allWords = [];
    let isHidden = false;

    // 從 Google Sheets 抓取 CSV 資料
    async function fetchData() {
        try {
            const csvUrl = G_SHEET_PUB_URL.replace('/pubhtml', '/pub?output=csv');
            const response = await fetch(csvUrl);
            const data = await response.text();
            
            // 解析 CSV (處理逗號與換行)
            const rows = data.split(/\r?\n/).slice(1);
            return rows.map(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return {
                    w: cols[0]?.replace(/"/g, '').trim(),
                    p: cols[1]?.replace(/"/g, '').trim(),
                    d: cols[2]?.replace(/"/g, '').trim(),
                    u: cols[3]?.replace(/"/g, '').trim()
                };
            }).filter(item => item.w);
        } catch (e) {
            alert('無法讀取雲端資料，請檢查 Google Sheets 發佈設定');
            return [];
        }
    }

    function render(data) {
        const content = document.getElementById('content');
        const loading = document.getElementById('loading');
        loading.style.display = 'none';
        
        // 按字母排序
        data.sort((a, b) => a.w.localeCompare(b.w, 'en', {sensitivity: 'base'}));
        
        let html = '';
        let lastLetter = '';

        data.forEach(item => {
            let currentLetter = item.w[0].toUpperCase();
            if (/[A-Z]/.test(currentLetter) && currentLetter !== lastLetter) {
                html += `<div class="letter-divider">${currentLetter}</div>`;
                lastLetter = currentLetter;
            }
            html += `
                <div class="word-card">
                    <div class="word-row">
                        <span class="word-text ${isHidden ? 'hide' : ''}">${item.w}</span>
                        <span class="pos">${item.p || ''}</span>
                    </div>
                    <div class="meaning">${item.d || ''}</div>
                    ${item.u ? `<div class="usage">${item.u}</div>` : ''}
                </div>
            `;
        });
        content.innerHTML = html || '<div class="loading">找不到匹配的單字</div>';
    }

    function toggleHide() {
        isHidden = !isHidden;
        filterData();
    }

    function filterData() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allWords.filter(i => 
            i.w.toLowerCase().includes(query) || 
            (i.d && i.d.includes(query))
        );
        render(filtered);
    }

    async function init() {
        allWords = await fetchData();
        render(allWords);
        document.getElementById('searchInput').addEventListener('input', filterData);
    }

    init();
</script>

</body>
</html>
